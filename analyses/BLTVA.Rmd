---
title: "Camille's BLTV & BLTVA plant data"
author: "Dr. Riley M. Anderson & Camille Wagstaff"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
graphics: yes
output:
  github_document:
    toc: yes
    toc_depth: 5
    pandoc_args: --webtex
  html_document:
    keep_md: yes
    theme: readable
    mathjax: default
  html_notebook:
    code_folding: hide
    theme: readable
    mathjax: default
  pdf_document:
    toc: yes
header-includes:
  \usepackage{float}
  \floatplacement{figure}{H}
editor_options:
  chunk_output_type: console
---

```{r setup, include = F}
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
# @@@@@ Knitr Options
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

# Set root directory to the project directory
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())


# Set default knitr options: 
# Suppress warnings and messages, cache chunks, 
#  set default figure size to 6x8 at 300 dpi, and save a png and pdf
knitr::opts_chunk$set(warning = F, message = F, collapse = T, cache = T,
    fig.height = 6, fig.width = 8, dpi = 300, # 6x8" @ 300dpi:1800x2400=4.3MP
    dev = c('png', 'pdf'), dev.args = list(pdf = list(onefile = F)))

```



## Overview

This analysis plots BLTVA and BCTV infection rates of plants.

The data used to generate these plots are:

* data/2019.csv
* data/2020.csv
* data/2021.csv

These data have been cleaned manually (species name errors) and are different from data on Camille's machine.

```{r Main_Code, include = F, cache = F}

# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
# @@@@@ Setup - This code is run, but output is hidden
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

# Load Packages
library(tidyverse) # Needed for data wrangling: dplyr, tidyr, ggplot2
library(cowplot) # Needed for publication-quality ggplots
library(glmmTMB)

# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
# @@@@@ Data Preparation
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

# Import datasets
d19 <- read.csv("data/2019.csv")
d20 <- read.csv("data/2020.csv")
d21 <- read.csv("data/2021.csv")

plants <- read.csv("data/Plants.new.csv")

plants.year <- read.csv("data/Plant_Data_2019_2021_JF_CW.csv")

```


```{r Data_Wrangling, echo = F, comment = ""}

d19 <- d19 %>% 
  # need to convert to char to join with 2021
  mutate(Sample = as.character(Sample))

d20 <- d20 %>% 
  # need to convert to char to join with 2021
  mutate(Sample = as.character(Sample))

dat1 <- bind_rows(d19, d20, d21) # join all years

dat1 <- dat1 %>% 
  # convert time period, region, plant spp, virus inf, and year to factors
  mutate(across(
    c(Time.period:Year), as.factor
  )) %>% 
  # remove "unknown plant" species
  filter(Plant != "Unknown plant")

# BLTVA
dat2 <- dat1 %>% 
  # remove the NAs
  filter(!is.na(BLTVA)) %>% 
  # count the number of plants in each year and time period for each level of BLTVA (i.e. infected or not infected)
  group_by(BLTVA, Year, Plant, Time.period) %>% 
  tally()

# This data below is not useful
#####################################
bltva <- dat2 %>% 
  # spread the BLTVA column across the other variables
  pivot_wider(values_from = n,
              names_from = BLTVA) %>% 
  # assign a meaningful name to the new column (0 = healthy, 1 = infected)
  rename(healthy = "0",
         infected = "1") %>% 
  # NAs generated by the spread -> 0
  replace_na(list(healthy = 0,
                  infected = 0)) %>% 
  # new column for the prop. infected
  mutate(prop.infected = infected / (infected + healthy))
#####################################


# New data
##########################################################

new.bltva <- plants %>% 
  mutate(across(c(Plant, BLTVA), as.factor)) %>% 
  group_by(Plant, BLTVA) %>% 
  tally() %>% 
  ungroup()

new.bctv <- plants %>% 
  mutate(Plant = factor(Plant),
         BCTV = factor(BCTV)) %>% 
  group_by(Plant, BCTV) %>% 
  tally() %>% 
  ungroup()

new.plants.sampled <- plants %>% 
  mutate(Plant = factor(Plant)) %>% 
  group_by(Plant) %>% 
  tally() %>% 
  rename(plants.sampled = n)

new.bctv <- left_join(new.bctv, new.plants.sampled, by = "Plant")

new.bltva <- left_join(new.bltva, new.plants.sampled, by = "Plant")


plants.year <- plants %>% 
  select(Year, Time.period, Specific, BCTV, BLTVA) %>% 
  rename(Plant = Specific)



plants.year2 <- plants.year %>% 
  mutate(across(c(Year:Plant), as.factor))



plants.year.inf <- plants.year %>% 
  filter(!is.na(Year)) %>% 
  mutate(across(c(Year:Plant), as.factor),
         infection = case_when(
           BLTVA == 0 & BCTV == 0 ~ "Healthy",
           BLTVA == 1 & BCTV == 0 ~ "BLTVA",
           BLTVA == 0 & BCTV == 1 ~ "BCTV",
           TRUE ~ "Co-infection"
         )) %>% 
  group_by(Year, infection) %>% 
  tally() %>% 
  ungroup()

plants_sampled_year <- plants.year %>% 
  mutate(Year = factor(Year)) %>% 
  group_by(Year) %>% 
  tally() %>% 
  filter(!is.na(Year),
         n > 9) %>% 
  ungroup() %>% 
  rename(total = n)

plants.year.inf <- left_join(plants.year.inf,
                             plants_sampled_year,
                             by = "Year")

##########################################################

# data for bubble plots
dat3 <- dat1 %>% 
  # remove NAs
  filter(!is.na(BLTVA)) %>% 
  # Count the number of plants in each BLTVA level
  group_by(BLTVA, Plant) %>% 
  tally() 

# how many individuals of each plant were sampled
plants_sampled <- dat1 %>% 
  group_by(Plant) %>% 
  tally() %>% 
  rename(plants.sampled = n)

# merge the plant counts with infected counts
dat4 <- left_join(dat3, plants_sampled, by = "Plant")

# create new variable: number of plants (infected or healthy)/ total number of plants sampled
bltva1 <- dat4 %>% 
  mutate(prop.infected = n/plants.sampled)

#########################################################
# BCTV (same process as above)
dat5 <- dat1 %>% 
  group_by(BCTV, Year, Plant, Time.period) %>% 
  tally()

bctv <- dat5 %>% 
  pivot_wider(values_from = n,
              names_from = BCTV) %>% 
  rename(healthy = "0",
         infected = "1") %>% 
  replace_na(list(healthy = 0,
                  infected = 0)) %>% 
  mutate(prop.infected = infected / (infected + healthy))



dat6 <- dat1 %>% 
  group_by(BCTV, Plant) %>% 
  tally() 

dat7 <- left_join(dat6, plants_sampled, by = "Plant")

bctv1 <- dat7 %>% 
  mutate(prop.infected = n/plants.sampled)


```

## Sample by host plant and season (split by years)

```{r sample_host_plant_season_year, echo = F, cache = F}

plants3 <- plants.year2 %>% 
  group_by(Year, Time.period, Plant, BCTV) %>% 
  tally() %>% 
  filter(n > 1) %>% 
  droplevels() %>% 
  ungroup()

plants3 %>% 
  ggplot(aes(x = Time.period, y = n, fill = Plant)) +
  geom_col(position = position_dodge()) +
  facet_wrap(~ Year, nrow = 3) +
  scale_x_discrete(limits = c(
    "Late March", "Early April", "Late April", "Early May", "Late May",
    "Early June", "Late June", "Early July", "Late July", "Early August",
    "Late August", "Early October", "Late October"
  )) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = "Plants sampled")



```

## Infection (BCTV) by host plant and season (split by years)

```{r infection_hosplant_season_year, echo = F, cache = F}

plants3 %>% 
  group_by(Time.period, Year, Plant) %>% 
  summarise(sumBCTV = sum(BCTV),
            sumN = sum(n)) %>% 
  mutate(prop.inf = sumBCTV/sumN) %>% 
  ggplot(aes(x = Time.period, y = prop.inf, fill = Plant)) +
  geom_col(position = position_dodge()) +
  facet_wrap(~ Year, nrow = 3) +
  scale_x_discrete(limits = c(
    "Late March", "Early April", "Late April", "Early May", "Late May",
    "Early June", "Late June", "Early July", "Late July", "Early August",
    "Late August", "Early October", "Late October"
  )) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = "Pr(Plants Infected with BCTV)")


```

```{r infection_hosplant_season1, echo = F, cache = F}

plants3 %>% 
  filter(Plant != "Grasses" & Plant != "Rabbitbrush" &
           Plant != "Silver sagebrush" & Plant != "Puncturevine" &
           Plant != "Prickly lettuce" & Plant != "Common purslane") %>% 
  group_by(Time.period, Year, Plant) %>% 
  summarise(sumBCTV = sum(BCTV),
            sumN = sum(n)) %>% 
  mutate(prop.inf = sumBCTV/sumN) %>% 
  ggplot(aes(x = Time.period, y = prop.inf, fill = Plant)) +
  geom_col(position = position_dodge()) +
  scale_x_discrete(limits = c(
    "Late March", "Early April", "Late April", "Early May", "Late May",
    "Early June", "Late June", "Early July", "Late July", "Early August",
    "Late August", "Early October", "Late October"
  )) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = "Pr(Plants Infected w/ BCTV)",
       x = "", fill = "Plant type")


```

## Plots

### Proportion infection class per year
```{r prop_infect_by_year, echo = F}
plants.year.inf %>% 
  ggplot(aes(x = Year, y = n/total, fill = infection)) +
  geom_col() +
  scale_fill_manual(values = c(
    "#E69F00", "#56B4E9", "#009E73", "#CC79A7"
  )) +
  theme_cowplot() +
  labs(y = "Proportion of samples",
       fill = "Infection status") +
  scale_y_continuous(limits = c(0, 1.15),
                     breaks = c(0, 0.25, 0.5, 0.75, 1)) +
  annotate(geom = "text", "2019", 1.1, label = "n = 114") +
  annotate(geom = "text", "2020", 1.1, label = "n = 250") +
  annotate(geom = "text", "2021", 1.1, label = "n = 73")


```

### BLTVA (new data)
```{r new_bltva_infected, echo = F}

new.bltva %>% 
  filter(BLTVA == 1) %>% 
  mutate(Prop.infected = n/plants.sampled) %>% 
  ggplot(aes(x = Prop.infected, y = Plant, size = plants.sampled)) +
  geom_point(shape = 21,
             fill = 'lightgray',
             color = 'black') +
  scale_size(range = c(1, 10),
             breaks = c(1, 50, 100, 200),
             limits = c(1, 200)) +
  theme_cowplot() +
  labs(x = "Proportion infection",
       y = "",
       size = "Sample size",
       title = "BLTVA infection")

```

### BCTV (new data)
```{r new_bctv_infected, echo = F}

new.bctv %>% 
  filter(BCTV == 1) %>% 
  mutate(Prop.infected = n/plants.sampled) %>% 
  ggplot(aes(x = Prop.infected, y = Plant, size = plants.sampled)) +
  geom_point(shape = 21,
             fill = 'lightgray',
             color = 'black') +
  scale_size(range = c(1, 10),
             breaks = c(1, 50, 100, 200),
             limits = c(1, 200)) +
  theme_cowplot() +
  labs(x = "Proportion infected",
       y = "",
       size = "Sample size",
       title = "BCTV Infection")

```


## GLM infection

### BLTVA model
```{r glm_BLTVA_new_data, echo = F}

bltva.data <- new.bltva %>% 
  filter(BLTVA == 1) %>% 
  mutate(prop.infected = n/plants.sampled)

bltva.glm <- glm(prop.infected ~ Plant,
                family = binomial(link = logit),
                weights = n,
                data = bltva.data)

summary(bltva.glm)


```


### BCTV model
```{r glm_bctv_new_data, echo = F}

bctv.data <- new.bctv %>% 
  filter(BCTV == 1) %>% 
  mutate(prop.infected = n/plants.sampled)

bctv.glm <- glm(prop.infected ~ Plant,
                family = binomial(),
                weights = n,
                data = bctv.data)

summary(bctv.glm)

```



```{r BLTVA_by_plant_and_time_period, echo = F, include = F}

bltva %>% 
  ggplot(aes(x = Time.period, y = prop.infected, fill = Plant)) +
  geom_bar(stat = 'identity', position = 'dodge') +
  coord_flip()

```

# BLTVA 

## BLTVA proportion infected

Proportion of infected individuals / total individuals sampled
```{r BLTVA_infection_by_Plant, echo = F}

bltva1 %>% 
  filter(BLTVA == "1") %>% 
  ggplot(aes(x = Plant, y = prop.infected, size = plants.sampled)) +
  geom_point(shape = 21,
             fill = 'lightgray',
             color = 'black') +
  scale_size(range = c(1, 10),
             breaks = c(1, 50, 100, 200),
             limits = c(1, 200)) +
  labs(x = "Plant species", y = "Prop. infected",
       size = "Plants sampled") +
  coord_flip() +
  theme_classic()

```

## BLTVA proportion healthy (not infected)

Proportion of healthy individuals / total individuals sampled
```{r BLTVA_healthy_by_plant, echo = F}
bltva1 %>% 
  filter(BLTVA == "0") %>% 
  ggplot(aes(x = Plant, y = prop.infected, size = plants.sampled)) +
  geom_point(shape = 21,
             fill = 'lightgray',
             color = 'black') +
  scale_size(range = c(1, 10),
             breaks = c(1, 50, 100, 200),
             limits = c(1, 200)) +
  labs(x = "Plant species", y = "Prop. healthy",
       size = "Plants sampled") +
  coord_flip() +
  theme_classic()

```

# BCTV

## BCTV proportion infected

Proportion of infected individuals / total individuals sampled
```{r BCTV_infected_by_Plant, echo = F}

bctv1 %>% 
  filter(BCTV == "1") %>% 
  ggplot(aes(x = Plant, y = prop.infected, size = plants.sampled)) +
  geom_point(shape = 21,
             fill = 'lightgray',
             color = 'black') +
  scale_size(range = c(1, 10),
             breaks = c(5, 50, 100, 200),
             limits = c(1, 200)) +
  labs(x = "plant species", y = "Prop infected",
       size = "Plants sampled") +
  coord_flip() +
  theme_classic()

# use this code below to add sample size cut offs
# bctv1 %>% 
#   filter(BCTV == "1" & plants.sampled > 9) %>% 
#   ggplot(aes(x = Plant, y = prop.infected, size = plants.sampled)) +
#   geom_point(shape = 21,
#              fill = 'lightgray',
#              color = 'black') +
#   scale_size(range = c(2, 10),
#              breaks = c(20, 50, 100, 200),
#              limits = c(20, 200)) +
#   labs(x = "plant species", y = "Prop infected",
#        size = "Plants sampled") +
#   coord_flip() +
#   theme_classic()

```

## BLTVA proportion healthy

Proportion of healthy individuals / total individuals sampled
```{r BCTV_healthy_by_plant, echo = F}
bctv1 %>% 
  filter(BCTV == "0") %>% 
  ggplot(aes(x = Plant, y = prop.infected, size = plants.sampled)) +
  geom_point(shape = 21,
             fill = 'lightgray',
             color = 'black') +
  scale_size(range = c(1, 10),
             breaks = c(1, 50, 100, 200),
             limits = c(1, 200)) +
  labs(x = "Plant species", y = "Prop. healthy",
       size = "Plants sampled") +
  coord_flip() +
  theme_classic()

```

# Session Information

```{r Session_Info, echo = F}

# Add session information to help with reproduceability
sessionInfo()


```


